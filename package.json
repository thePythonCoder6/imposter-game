{import express from 'express';
import { createServer } from 'http';
import { Server } from 'socket.io';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const server = createServer(app);
const io = new Server(server, {
  cors: {
    origin: '*',
    methods: ['GET', 'POST']
  },
  pingTimeout: 60000,
  pingInterval: 25000
});

// Serve static files from 'public' folder
app.use(express.static(path.join(__dirname, 'public')));

// Serve index.html for all routes
app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// All categories (full list â€“ paste your complete object here if needed)
const categories = {
  food: ["Pizza", "Burger", "Sushi", "Tacos", "Pasta", "Ramen", "Curry", "Pho", "Dim Sum", "Paella", "Butter Chicken", "Pad Thai", "Lasagna", "Burrito", "Falafel", "Shawarma", "Kebab", "Poutine", "Fish & Chips", "Bangers & Mash", "Pie Floater", "Hamburger", "Hot Dog", "Nachos", "Quesadilla", "Enchilada", "Chimichanga", "Biryani", "Laksa", "Tom Yum", "Satay", "Spring Rolls", "Dumplings", "Gyros", "Souvlaki", "Pierogi", "Ceviche", "Poke Bowl", "Bibimbap", "Katsu Curry", "Carbonara", "Risotto", "Tagine", "Jollof Rice", "Feijoada", "Empanada", "Schnitzel", "Paella", "Goulash"],
  // ... add all other categories here exactly as in your client-side version
  // (to save space I truncated, but you must include the full object)
};

// In-memory rooms
const rooms = {};

io.on('connection', (socket) => {
  console.log(`New connection: ${socket.id}`);

  socket.on('createRoom', ({ name, category }) => {
    const code = Math.random().toString(36).substring(2, 8).toUpperCase();
    const wordList = categories[category] || categories.food;
    const secret = wordList[Math.floor(Math.random() * wordList.length)];

    rooms[code] = {
      secret,
      players: [{ id: socket.id, name }],
      status: 'lobby',
      host: socket.id,
      imposter: null
    };

    socket.join(code);
    socket.emit('roomCreated', { code });
    io.to(code).emit('playersUpdate', rooms[code].players);
  });

  socket.on('joinRoom', ({ code, name }) => {
    code = code.toUpperCase();
    const room = rooms[code];
    if (!room) return socket.emit('error', 'Room not found');
    if (room.players.some(p => p.name === name)) return socket.emit('error', 'Name already taken');

    room.players.push({ id: socket.id, name });
    socket.join(code);
    io.to(code).emit('playersUpdate', room.players);
    socket.emit('joined', { code });
  });

  socket.on('startGame', (code) => {
    code = code.toUpperCase();
    const room = rooms[code];
    if (!room || socket.id !== room.host) return socket.emit('error', 'Only host can start game');
    if (room.players.length < 3) return socket.emit('error', 'Need at least 3 players');

    room.imposter = Math.floor(Math.random() * room.players.length);
    room.status = 'playing';
    io.to(code).emit('gameStarted', {
      imposterIndex: room.imposter,
      secret: room.secret
    });
  });

  socket.on('reveal', (code) => {
    code = code.toUpperCase();
    const room = rooms[code];
    if (!room || socket.id !== room.host) return socket.emit('error', 'Only host can reveal');

    io.to(code).emit('gameRevealed', {
      imposterName: room.players[room.imposter].name,
      secret: room.secret
    });
  });

  socket.on('ping', () => {});

  socket.on('disconnect', () => {
    console.log(`Disconnected: ${socket.id}`);
  });
});

const PORT = process.env.PORT || 3000;
server.listen(PORT, () => {
  console.log(`Server listening on port ${PORT}`);
});
